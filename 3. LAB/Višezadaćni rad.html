
<!-- saved from url=(0094)http://zemris.fer.hr/predmeti/os/pripreme/upute/visezadacnirad.html#ZAJEDNICKI_ADRESNI_PROSTOR -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">

<link rel="Edit-Time-Data" href="http://zemris.fer.hr/predmeti/os/pripreme/upute/procesi_files/editdata.mso">
<title>Vi¹ezadaæni rad</title>
<style>
<!--
 /* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman"; margin-left:0cm; margin-right:0cm; margin-top:0cm}
p
	{margin-right:0cm;
	mso-margin-top-alt:auto;
	mso-margin-bottom-alt:auto;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
pre
	{margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Courier New";}
tt
	{mso-ascii-font-family:"Courier New";
	mso-fareast-font-family:"Courier New";
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Courier New";}
p.Izvornikod, li.Izvornikod, div.Izvornikod
	{mso-style-name:"Izvorni kod";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:2.0pt;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";
	color:teal;
	mso-ansi-language:HR;
	font-weight:bold;
	mso-bidi-font-weight:normal;}
@page Section1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	mso-header-margin:35.4pt;
	mso-footer-margin:35.4pt;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
 /* List Definitions */
@list l0
	{mso-list-id:271134136;
	mso-list-type:hybrid;
	mso-list-template-ids:1527679826 1756025018 -243781946 -637478096 2054344232 1869506732 554752390 1727416870 739779268 942978190;}
@list l1
	{mso-list-id:708991120;
	mso-list-type:hybrid;
	mso-list-template-ids:-1683963084 1081489494 -890476698 336132102 -2014434126 943204930 -1352486766 1655200276 986901518 1698202868;}
@list l1:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:36.0pt;
	mso-level-number-position:left;
	text-indent:-18.0pt;
	mso-ansi-font-size:10.0pt;
	font-family:Symbol;}
ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>
</head>

<body lang="EN-GB" style="">

<h1><span style="text-transform: uppercase">Vi¹ezadaæni rad</span></h1>


<div class="MsoNormal" align="center" style="text-align:center">

<h3 style="text-align: left"> Upute za laboratorijske vje¾be</h3>


<hr size="1" width="100%" align="center">

</div>


<p>Vi¹ezadaæni rad moguæe je ostvariti s pomoæu vi¹e procesa ili s pomoæu vi¹e 
dretvi.</p>


<h2>1. Ostvarenje vi¹ezadaænog rada s pomoæu vi¹e procesa</h2>

<p>Program je skup instrukcija i podataka koji se nalaze u datoteci na disku. U
opisu datoteke ona je opisana kao izvr¹na i njen sadr¾aj je organiziran prema
pravilima jezgre. Sve dok sadr¾aj datoteke odgovara pravilima i dok je oznaèena
kao izvr¹na, program mo¾e biti pokrenut. Kako bi se pokrenuo novi program prvo
treba (pozivom jezgre) stvoriti novi proces koji je okolina u kojem se izvr¹ava
program.</p>

<p>Proces se sastoji od tri segmenta: segment instrukcija, segment korisnièkih
podataka i segment sustavskih podataka. Program inicijalizira segment
instrukcija i korisnièke podatke. Nakon inicijalizacije vi¹e nema èvste veze
izmeðu procesa i programa koji on izvodi. Proces dobiva sredstva (vi¹e
spremnika, datoteke, itd.) koji nisu prisutni u samom programu, mijenja podatke,
itd. Iz jednog programa mo¾e se inicijalizirati vi¹e procesa koji se paralelno
izvode.</p>

<h3>Sustavski poziv <i>fork</i></h3>

<p>Sustavskim pozivom <i>fork</i> zahtijeva se stvaranje novog procesa iz 
postojeæeg. Kada
proces koji se trenutno izvodi pokrene novi proces, pokrenuti proces postaje
"dijete" procesa "roditelja" koji ga je pokrenuo. Dijete
dobija kopije segmenta instrukcija i segmenta podataka roditelja. U stvari, buduæi
da se segment instrukcija najèe¹æe ne mijenja, jezgra mo¾e u¹tediti vrijeme i
memoriju tako da postavi taj segment kao zajednièki za oba procesa (sve dok ga
jedan od njih ne odluèi inicijalizirati novim programom, tj. pokrenuti drugi 
program primjerice naredbom <i>exec</i>). Takoðer, dijete
nasljeðuje veæinu sustavskih podataka roditelja.</p>

<pre>int fork(void);</pre>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">U
ovaj sustavski poziv ulazi jedan proces, a iz njega izlaze dva odvojena procesa
("dijete" i "roditelj") koji dobivaju svaki svoju povratnu
vrijednost. Proces dijete dobiva rezultat 0, a roditelj dobiva identifikacijski
broj procesa djeteta. Ako doðe do gre¹ke, vraæena vrijednost je -1, a dijete
nije ni stvoreno. <i>fork</i> nema nikakvih argumenata, pa programer ne mo¾e
biti odgovoran za gre¹ku veæ je ona rezultat nemoguænosti jezgre da kreira novi
proces zbog nedostatka nekog od potrebnih sredstava.</p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Dijete
nasljeðuje veæinu atributa iz segmenta sustavskih podataka kao ¹to su aktualni
direktorij, prioritet ili identifikacijski broj korisnika. Manje je atributa
koji se ne nasljeðuju:</p>

<ul type="disc">
 <li class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l1 level1 lfo3;tab-stops:list 36.0pt">Identifikacijski brojevi
     procesa djeteta i roditelja su razlièiti, jer su to razlièiti procesi.</li>
 <li class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l1 level1 lfo3;tab-stops:list 36.0pt">Proces dijete dobiva kopije
     otvorenih opisnika datoteka (<i>file descriptor</i>) od roditelja. Dakle
     to nisu isti opisnici datoteka, tj. procesi ih ne dijele. Meðutim, procesi
     dijele kazaljke polo¾aja u datotekama (<i>file pointer</i>). Ako jedan
     proces namjesti kazaljku polo¾aja na odreðeno mjesto u datoteci, drugi
     proces æe takoðer èitati odnosno pisati od tog mjesta. Za razliku od toga,
     ako dijete zatvori svoj opisnik datoteke, to nema veze s roditeljevim opisnikom
     datoteke.</li>
 <li class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
     mso-list:l1 level1 lfo3;tab-stops:list 36.0pt">Vrijeme izvoðenja procesa
     djeteta je postavljeno na nula.</li>
</ul>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Dijete
se mo¾e inicijalizirati novim programom (poziv <i>exec</i>) ili izvoditi
poseban dio veæ prisutnog programa, dok roditelj mo¾e èekati da dijete zavr¹i
ili paralelno raditi ne¹to drugo. Osnovni oblik upotrebe sustavskog poziva <i>fork
</i>izgleda ovako:</p>

<pre><b><font color="#0000FF">if (fork() </font><font color="#009933">== 0) {</font></b></pre><pre><b><font color="#FF0000"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><i>posao procesa djeteta</i></font></b></pre><pre><b><font color="#FF0000"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>exit(0);</font></b></pre><pre><b><font color="#0000FF">}</font></b></pre><pre><b><font color="#0000FF"><i>nastavak rada procesa roditelja (ili ni¹ta);</i></font></b></pre><pre><b><font color="#0000FF">wait(NULL);</font></b></pre>
<p><b><font color="#0000FF">Plavo</font></b> - izvodi proces roditelj, <b>
<font color="#009933">zeleno</font></b> - izvode oba procesa (provjera povratne 
vrijednosti fork()-a), <font color="#FF0000"><b>crveno</b></font> - izvodi 
proces djeteta.</p>

<h3 style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Sustavski
pozivi <i>exit,</i> <i>wait <font color="#FF0000">i getpid</font></i></h3>

<pre>void exit(int status) ;</pre>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">
Poziv <i>exit </i>zavr¹ava
izvoðenje procesa koji poziva tu funkciju. Prije zavr¹etka, uredno se
zatvaraju sve otvorene datoteke. Ne vraæa nikakvu vrijednost jer iza njega nema
nastavka procesa. Za <i>status</i> se obièno stavlja 0 ako proces normalno
zavr¹ava, a 1 inaèe. Roditelj procesa koji zavr¹ava pozivom <i>exit</i> prima
njegov <i>status</i> preko sustavskog poziva <i>wait</i>.</p>

<pre>int wait(int *statusp) ;</pre>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Ovaj
sustavski poziv èeka da neki od procesa djece zavr¹i (ili bude zaustavljen za
vrijeme praæenja), 
<span class="Apple-style-span" style="color: rgb(0, 0, 0); font-family: arial, sans-serif; font-size: 13px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); ">
s tim da se ne mo¾e definirati na koji proces treba èekati (doèekuje se prvi 
proces dijete koji zavr¹i)</span>. 
Funkcija vraæa
identifikacijski broj procesa djeteta koji je zavr¹io i sprema njegov status
(16 bitova) u cijeli broj na koji pokazuje <i>statusp</i>, osim ako je taj
argument <tt><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">NULL</span></tt>.
U tom sluèaju se status zavr¹enog procesa gubi. U sluèaju gre¹ke (djece nema,
ili je èekanje prekinuto primitkom signala) rezultat je ­1.</p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Postoje
tri naèina kako mo¾e zavr¹iti proces: pozivom <i>exit</i>, primitkom signala
ili padom sustava (nestanak napajanja ili slièno). Na koji je naèin proces
zavr¹io mo¾emo proèitati iz statusa na koji pokazuje <i>statusp</i> osim ako se
radi o treæem sluèaju (vidi <tt><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">man
wait</span></tt>).</p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Ako
proces roditelj zavr¹i prije svog procesa djeteta, djetetu se dodjeljuje novi
roditelj - proces <i>init</i> s identifikacijskim brojem 1. <i>init</i> je
va¾an prilikom pokretanja sustava, a u kasnijem radu veæinom izvodi <i>wait</i>
i tako "prikuplja izgubljenu djecu" kada zavr¹e.</p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Ako
proces dijete zavr¹i, a roditelj ga ne èeka sa <i>wait</i>, on postaje
proces-zombi (<i>zombie</i>). Otpu¹taju se njegovi segmenti u radnom spremniku, ali se
zadr¾avaju njegovi podaci u tablici procesa. Oni su potrebni sve dok roditelj
ne izvede <i>wait</i> kada proces-zombi nestaje. Ako roditelj zavr¹i, a da nije
pozvao <i>wait</i>, proces-zombi dobiva novog roditelja (<i>init</i>) koji æe
ga prikupiti sa <i>wait</i>.</p>

<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#FF0000">pid_t getpid() ;</font></pre>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">
<font color="#FF0000">Poziv <i>getpid </i>vraæa identifikacijski broj procesa 
(PID).</font></p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">&nbsp;</p>

<h3 style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Pokretanje
paralelnih procesa</h3>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">U
ovoj vje¾bi trebat æe pokrenuti vi¹e procesa tako da rade paralelno. To se mo¾e
izvesti s dvije petlje. U prvoj se stvaraju procesi djeca pozivom <i>fork</i>
a svako dijete poziva odgovarajuæu funkciju. Iza poziva funkcije treba se
nalaziti <i>exit</i> jer samo roditelj nastavlja izvr¹avanje petlje. Nakon
izlaska iz prve petlje, roditelj poziva <i>wait</i> toliko puta koliko je
procesa djece stvorio.</p>

<pre>for (i = 0; i &lt; N; i++)</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; switch</span> (fork()) {</pre><pre>   case 0:</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><i>funkcija koja obavlja posao djeteta</i> <b>i</b></pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(0);</pre><pre>   case -1:</pre><pre>      <i>ispis poruke o nemoguænosti stvaranja procesa;
</i>   dafault:
      <i>nastavak posla roditelja;</i></pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>}</pre><pre>&nbsp;</pre><pre>while (i--)<span style="mso-spacerun: yes"> </span>wait (NULL);</pre>

<h3 style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">
<a name="ZAJEDNICKI_ADRESNI_PROSTOR">ZAJEDNIÈKI
ADRESNI PROSTOR</a></h3>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Nakon
stvaranja novog procesa sa <i>fork</i>, procesi roditelj i dijete dijele
segment s podacima koji se sastoji od stranica. Sve dok je stranica
nepromjenjena oba procesa je mogu èitati. Ali èim jedan proces poku¹a pisati na
stranicu procesi dobiva odvojene kopije podataka. Tada niti globalne varijable
nisu zajednièke za sve procese, pa ako jedan proces promjeni neku varijablu
drugi to neæe primijetiti. To je jedan od razloga za kori¹tenje zajednièkog
spremnika. Varijable koja trebaju biti zajednièke za sve procese moraju se
nalaziti u zajednièkom spremniku kojeg prethodno treba zauzeti.</p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Zajednièki
spremnièki prostor je najbr¾i naèin komunikacije meðu procesima. Isti
spremnik je
prikljuèen adresnim prostorima dva ili vi¹e procesa. Èim je ne¹to upisano u
zajednièki spremnik, istog trenutka je dostupno svim procesima koji imaju
prikljuèen taj dio zajednièkog spremnika na svoj adresni prostor. Za
sinkronizaciju èitanja i pisanja u zajednièki spremnik mogu se upotrijebiti
semafori, poruke ili posebni algoritmi.</p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Blok
zajednièkog spremnika se kraæe naziva segment. Mo¾e biti vi¹e zajednièkih
segmenata koji su zajednièki za razliète kombinacije aktivnih procesa. Svaki
proces mo¾e pristupiti k vi¹e segmenata. Segment je prvo stvoren izvan adresnog
prostora bilo kojeg procesa, a svaki proces koji ¾eli pristupiti segmentu
izvr¹ava sustavski poziv kojim ga ve¾e na svoj adresni prostor. Broj segmenata
je odreðen sklopovskim ogranièenjima, a velièina segmenta mo¾e takoðer biti
ogranièena.</p>

<h3 style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Sustavski
pozivi za stvaranje i rad sa zajednièkim spremnikom</h3>

<pre>typedef key_t int;</pre><pre>int shmget(key_t key, int size, int flags) ;</pre>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Ovaj
sustavski poziv pretvara kljuè (<i>key</i>) nekog segmenta zajednièkog
spremnika u njegov identifikacijski broj ili stvara novi segment. Novi segment duljine
barem <i>size</i> bajtova æe biti stvoren ako se kao kljuè upotrijebi <tt><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">IPC_PRIVATE</span></tt>. U
devet najni¾ih bitova <i>flags</i> se stavljaju dozvole pristupa (na primjer,
oktalni broj 0600 znaèi da korisnik mo¾e èitati i pisati, a grupa i ostali ne
mogu). <i>shmget</i> vraæa identifikacijski broj segmenta koji je potreban u <i>shmat</i>
ili -1 u sluèaju gre¹ke.</p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Proces
ve¾e segment na svoj adresni prostor sa <i>shmat</i>:</p>

<pre>char *shmat(int segid, char *addr, int flags) ;</pre>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Ako
segment treba vezati na odreðenu adresu treba je staviti u <i>addr</i>, a ako
je <i>addr</i> jednako <tt><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">NULL</span></tt>
jezgra æe sama odabrati adresu (moguæe ako se kasnije ne koristi dinamièko
zauzimanje spremnika s <i>malloc</i> ili slièno). <i>flags</i> takoðer najèe¹æe
mo¾e biti 0. <i>segid</i> je identifikacijski broj segmenta dobijen pozivom <i>shmget</i>.<i>
shmat </i>vraæa kazaljku na zajednièki adresni prostor duljine tra¾ene u shmget ili -1
ako doðe do gre¹ke. Dohvaæanje i spremanje podataka u segmente obavlja se na
uobièajen naèin.</p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Segment
se mo¾e otpustiti sustavskim pozivom <i>shmdt</i>:</p>

<pre>int shmdt(char *addr) ;</pre>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Zajednièki
spremnièki prostor ostaje nedirnut i mo¾e mu se opet pristupiti tako da se
ponovno ve¾e na adresni prostor procesa, iako je moguæe da pri tome dobije drugu
adresu u njegovom adresnom prostoru. <i>addr</i> je adresa segmenta dobivena
pozivom <i>shmat</i>.</p>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Uni¹tavanje
segmenta zajednièke memorije izvodi se sustavskim pozivom <i>shmctl</i>:</p>

<pre>int shmctl(int segid, int cmd, struct shmid_ds *sbuf) ;</pre>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Za
uni¹tavanje segmenta treba za <i>segid</i> staviti identifikacijski broj
dobiven sa <i>shmget</i>, <i>cmd</i> treba biti <tt><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;">IPC_RMID</span></tt>, a <i>sbuf</i> mo¾e biti
<tt><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">NULL</span></tt>.
Gre¹ka je uni¹titi segment koji nije otpu¹ten iz adresnog prostora svih procesa
koji su ga koristili. <i>shmctl</i>, kao i<i> shmdt</i> vraæa 0 ako je sve u
redu, a -1 u sluèaju gre¹ke. (Detaljnije o ovim pozivima u: <tt><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">man shmget</span></tt>, <tt><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">man shmop</span></tt>, <tt><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">man shmctl</span></tt>)</p>

<h3 style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Struktura
programa sa paralelnim procesima i zajednièkim spremnikom</h3>

<pre><i>definiranje kazaljki na zajednièke varijable</i></pre><pre></pre><pre>proces <b>k</b></pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><u>poèetak</u></pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><i>proces koji koristi zajednièke varijable</i></pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>...</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><u>kraj</u></pre><pre>...</pre><pre></pre><pre>glavni program</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><u>poèetak</u></pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>zauzimanje zajednièke memorije</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pokretanje paralelnih procesa</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>oslobaðanje zauzete zajednièke memorije</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span><u>kraj</u></pre>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt"><b>VA®NO</b>:
Varijablama u zajednièkom spremniku se nu¾no pristupa kori¹tenjem kazaljki.</p>

<h3 style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Primjer
programa sa paralelnim procesima i zajednièkim spremnikom</h3>

<p style="tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt">Ovo
je trivijalan primjer kori¹tenja zajednièkog spremnika. Koristi se jedna
cjelobrojna zajednièka varijabla. Stvaraju se dva paralelna procesa, od kojih
jedan upisuje vrijednost (razlièitu od 0) u tu varijablu, a drugi èeka da ona
bude upisana.</p>

<pre>#include &lt;stdio.h&gt;</pre>
<pre>#include &lt;signal.h&gt;</pre><pre>#include &lt;sys/types.h&gt;</pre><pre>#include &lt;sys/ipc.h&gt;</pre><pre>#include &lt;sys/shm.h&gt;</pre><pre></pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt">int Id;<span style="mso-spacerun: yes">&nbsp;</span>/* <i>identifikacijski broj segmenta</i> */</pre><pre>int *ZajednickaVarijabla;</pre><pre>&nbsp;</pre>
<pre>void Pisac(int i)
{</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>*ZajednickaVarijabla = i;</pre><pre>}</pre><pre></pre><pre>void Citac(void)
{</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>int i;</pre><pre></pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>do {</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>i = *ZajednickaVarijabla;</pre>
<pre>      printf("Procitano %d\n", i);</pre>
<pre>      sleep(1);</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>} while (i == 0);</pre><pre></pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>printf("Procitano je: %d\n", i);</pre><pre>}</pre><pre>void brisi(int sig)
{</pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>/* <i>oslobaðanje zajednièke memorije</i> */</pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>(void) shmdt((char *) ZajednickaVarijabla);</pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>(void) shmctl(Id, IPC_RMID, NULL);</pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>exit(0);</pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"></pre>
<pre>}</pre>
<pre>int main(void)
{</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>/* <i>zauzimanje zajednièke memorije</i> */</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>Id = shmget(IPC_PRIVATE, sizeof(int), 0600);</pre>
<pre>&nbsp;</pre>
<pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>if (Id == -1)</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(1);<span style="mso-spacerun: yes">&nbsp; </span>/* <i>gre¹ka - nema zajednièke memorije</i> */</pre><pre>&nbsp;</pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>ZajednickaVarijabla = (int *) shmat(Id, NULL, 0);</pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><span style="mso-spacerun: yes">&nbsp;&nbsp; *</span>ZajednickaVarijabla = 0;</pre>
<pre>   sigset(SIGINT, brisi);//u sluèaju prekida bri¹i memoriju</pre>
<pre>&nbsp;</pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>/* <i>pokretanje paralelnih procesa</i> */</pre>
<pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>if (fork() == 0) {</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Citac();</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(0);</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>}</pre>
<pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>if (fork() == 0) {</pre>
<pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt">      sleep(5);</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Pisac(123);</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exit(0);</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>}</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>(void) wait(NULL);</pre><pre><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>(void) wait(NULL);</pre>
<pre>   brisi(0);</pre><pre></pre><pre>&nbsp;</pre>
<pre><span style="mso-spacerun: yes">&nbsp;&nbsp; return 0</span>;</pre><pre>}</pre>

<p style="tab-stops:36.0pt">Ako se segment zajednièkog spremnika ne uni¹ti,
zajednièki adresni prostor ostaje trajno zauzet i nakon zavr¹etka svih procesa koji
ga koriste, pa èak i nakon ¹to korisnik koji ga je stvorio napusti raèunalo <tt><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">(logout</span></tt>). </p>
<p style="tab-stops:36.0pt"><b>Ukoliko se koristi zajednièko raèunalo</b> za vi¹e korisnika i buduæi
je broj segmenata ogranièen, to ubrzo mo¾e izazvati nemoguænost rada programa
koji koriste zajednièki spremnik. (Isto vrijedi i za ostala sredstva za
meðuprocesnu komunikaciju: skupove semafora i redove poruka.) Podaci o
upotrijebljenim sredstvima za meðuprocesnu komunikaciju mogu se dobiti
naredbom: <i>ipcs</i>. Naredbom <i>ipcrm</i> mogu se uni¹tavati pojedina sredstva
(vidi: <i> man ipcrm, man ipcs</i>). Za lak¹e uni¹tavanje zaostalih segmenata
zajednièkog spremnika (kao i skupova semafora i redova poruka) mo¾e poslu¾iti
jednostavan program <i>brisi</i>:</p>

<pre><tt><a name="Brisanje memorije"></a>#include &lt;stdio.h&gt;</tt></pre><pre><tt>#include &lt;sys/types.h&gt;</tt></pre><pre><tt>#include &lt;sys/ipc.h&gt;</tt></pre><pre><tt>#include &lt;sys/shm.h&gt;</tt></pre><pre><tt>#include &lt;sys/sem.h&gt;</tt></pre><pre><tt>#include &lt;sys/msg.h&gt;</tt></pre><pre><tt>#include &lt;values.h&gt;</tt></pre><pre></pre><pre><tt>
int main ( void ) </tt></pre><pre><tt>{</tt></pre><pre><tt><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>int i;</tt></pre><pre></pre><pre><tt><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>for (i = 1; i &lt; MAXLONG; i++) {</tt></pre><pre><tt><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if (shmctl(i, IPC_RMID, NULL) != -1)</tt></pre><pre><tt><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("Obrisao zajednicku memoriju %d\n", i); </tt></pre><pre><tt><span style="mso-spacerun: yes">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if (semctl(i, 0, IPC_RMID, 0) != -1)</tt></pre><pre><tt><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("Obrisao skup semafora %d\n", i); </tt></pre><pre><tt><span style="mso-spacerun: yes">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if (msgctl(i, IPC_RMID, NULL) != -1)</tt></pre><pre><tt><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>printf("Obrisao red poruka %d\n", i); </tt></pre><pre><tt><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;</span>}</tt></pre><pre></pre><pre><tt><span style="mso-spacerun: yes">&nbsp;&nbsp; </span>return 0;</tt></pre><pre><tt>}</tt></pre>
<p><span style="" lang="HR"><font size="3">U svaki program ukljuèiti 
moguænost prijevremenog izlaska iz programa (ctrl+C) na naèin kao ¹to je to 
ostvareno u prvoj vje¾bi, s tim da prekidna rutina bri¹e zauzete sustavske 
resurse (semafore i zajednièki spremnik) prije no ¹to program zavr¹i.</font></span></p>

<font size="5">

<b><hr><h2 align="left">2. Vi¹edretvenost</h2>
</b></font><p align="JUSTIFY">Povijest vi¹edretvenog programiranja poèinje 60-tih, dok se njihova implementacija na UNIX sustavima pojavljuje sredinom 80-tih godina, a na ostalim sustavima ne¹to kasnije. Ideja vi¹edretvenog programiranja jest u tome da se program sastoji od vi¹e jedinica koje se samostalno mogu izvoditi. Programer ne mora brinuti o redoslijedu njihova izvoðenja, veæ to obavlja sam operacijski sustav. ©tovi¹e, ukoliko je to vi¹eprocesorski sustav, onda se neke jedinice-dretve mogu izvoditi istovremeno. 
Komunikacija meðu dretvama je jednostavna i br¾a u odnosu na komunikaciju meðu procesima, jer se obavlja preko zajednièkog adresnog prostora, te se mo¾e obaviti bez uplitanja operacijskog sustava. </p>
<p align="CENTER"><img border="0" src="./Vi¹ezadaæni rad_files/viseza2.gif"></p>
<i>
<b><p align="center">Slika: Arhitektura vi¹edretvenog sustava</p>
</b></i>
<p align="JUSTIFY">Operacijski sustav za koji su predviðene ove laboratorijske 
vje¾be jest UNIX sustav koji podr¾ava POSIX dretve. Gornja slika prikazuje 
primjere procesa s jednom, dvije, tri, dvije i èetiri dretve. Uobièajeno je da 
operacijski sustav rasporeðuje dretve na raspolo¾ive procesore te se u gornjoj 
slici svaka dretva vidi i u operacijskom sustavu, tj. svakoj dretvi pripada 
virtualni procesor, na slici oznaèen s LWP (Light Weight Process).<br>
Neki sustavi dozvoljavaju i djelomièno upravljanje dretvama u procesima, pa tako 
broj dretvi u procesu mo¾e biti i veæi nego ¹to operacijski sustav vidi 
(pogledati poziv thr_create u Solarisu i pojmove "bound" i "unbound" dretve; "<a href="http://en.wikipedia.org/wiki/Fiber_(computer_science)">fiber</a>"-i 
na Win* i sl.).</p><font size="4">
<b>
<p align="JUSTIFY">Funkcije za rukovanje dretvama</p>
</b>
<p align="JUSTIFY">U nastavku su obja¹njene funkcije po POSIX standardu (pogledati <font face="Courier New" size="2">man threads</font>).</p>
<b><i>
<p align="JUSTIFY">Stvaranje dretvi</p>
</i>
</b></font><p align="JUSTIFY">Sve dretve, osim prve, inicijalne, koja nastaje stvaranjem procesa, nastaju pozivom 
<font face="Courier New" size="2"> pthread_create:</font></p>
<font face="Courier New" size="2">
<div align="justify">
  <pre><font size="2">   int pthread<i>_</i>create(pthread<i>_</i>t *thread, const pthread<i>_</i>attr<i>_</i>t *attr,</font></pre>
</div>
<div align="justify">
  <pre><font size="2">                      void *(*start<i>_</i>routine)(void *), void *arg);</font></pre>
</div></font>
<p align="JUSTIFY"><font face="Courier New" size="2">thread</font> je kazaljka na mjesto u memoriji gdje se sprema<font face="Courier New" size="2">
id </font>novostvorene dretve<font size="2" face="Courier New">. attr</font> 
je adresa strukture koja sadr¾i podatke o atributima s kojima se ¾eli stvoriti 
dretvu. Ako se za attr postavi <font face="Courier New" size="2">NULL</font> onda se uzimaju pretpostavljene vrijednosti 
(dovoljno dobre za lab. vje¾be). <font size="3"><font face="Courier New" size="2">start_routine</font> 
predstavlja pokazivaè na poèetnu funkciju koju æe novostvorena dretva imati kao 
poèetnu (npr. kao ¹to glavna dretva ima funkciju <font face="Courier New" size="2">main</font>).
<font face="Courier New" size="2">arg</font> je adresa parametra koji se prenosi dretvi 
(mo¾e biti </font>NULL<font size="3"> ako se ni¹ta ne prenosi). Buduæi da 
se mo¾e prenijeti samo jedan parametar u sluèaju potrebe prijenosa vi¹e 
parametara oni se pohranjuju u strukturu te se ¹alje pokazivaè na tu struktru.</font></p>
<font size="4"><i><b><p align="JUSTIFY">Zavr¹etak rada dretve</p>
</b></i></font><p align="JUSTIFY">Normalan zavr¹etak dretve jest njen izlazak iz prve, inicijalne funkcije, ili pozivom funkcije <font face="Courier New" size="2">
pthread_exit</font>: </p>
<p align="JUSTIFY">
<font face="Courier New" size="2">int pthread_exit(void *status);</font></p><font face="Courier New" size="2">
</font><p align="JUSTIFY"><font face="Courier New" size="2"><font face="Courier New" size="2">status</font></font> je kazaljka na stanje sa kojim dretva zavr¹ava. </p>
<p align="JUSTIFY">Dretva èeka na zavr¹etak druge dretve pozivom funkcije
<font face="Courier New" size="2">pthread_join</font>:</p>
<p align="JUSTIFY">
<font face="Courier New" size="2">int pthread_join( pthread_t cekana_dr, void **stanje);
</font></p>
<p align="JUSTIFY">
<font face="Courier New" size="2">cekana_dr</font> je identifikacijski broj dretve na èiji se kraj èeka 
(<i>thr_join</i>). <font face="Courier New" size="2">stanje</font> je kazaljka na kazaljku izlaznog statusa doèekane dretve. Funkcija
<font face="Courier New" size="2">pthread_join</font> zaustavlja izvoðenje pozivajuæe dretve sve dok odreðena dretva ne zavr¹i sa radom. Nakon ispravnog zavr¹etka funkcija vraæa nulu.</p>
<p align="JUSTIFY">Normalni zavr¹etak vi¹edretvenog programa zbiva se kada sve dretve zavr¹e
s radom, odnosno, kada prva, poèetna dretva izaðe iz prve funkcije (<i>main</i>)<i>.</i> Prijevremeni zavr¹etak zbiva se pozivom funkcije <i>exit</i> od strane bilo koje dretve, ili pak nekim vanjskim signalom (<font face="Courier New" size="2">SIGKILL</font>, <font face="Courier New" size="2">SIGSEGV</font>, <font face="Courier New" size="2">SIGINT</font>, <font face="Courier New" size="2">SIGTERM</font>, ...).</p>
<p align="JUSTIFY"><font face="Times New Roman" size="3">Primjer jednog 
vi¹edretvenog programa koji koristi istu varijablu:</font></p>
<font size="4">
<div align="justify">
  <pre>#include &lt;stdio.h&gt;
#include &lt;pthread.h&gt;

int ZajednickaVarijabla;

void *Pisac(void *x)
{
   ZajednickaVarijabla = *((int*)x);
}

void *Citac(void *x)
{
   int i;

   do {
      i = ZajednickaVarijabla;
      printf("Procitano %d\n", i);</pre>
  <pre style="tab-stops: 45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt; font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt">      sleep(1);</pre>
  <pre>   } while (i == 0);

   printf("Procitano je: %d\n", i);
}

int main(void)
{
   int i;</pre>
  <pre>   pthread_t thr_id[2];

   ZajednickaVarijabla = 0;
   i=123;

   /* pokretanje dretvi */
   if (pthread_create(&amp;thr_id[0], NULL, Citac, NULL) != 0) {
      printf("Greska pri stvaranju dretve!\n");
      exit(1);
   }
   sleep(5);
   if (pthread_create(&amp;thr_id[1], NULL, Pisac, &amp;i) != 0) {
      printf("Greska pri stvaranju dretve!\n");
      exit(1);
   }

   pthread_join(thr_id[0], NULL);
   pthread_join(thr_id[1], NULL);

   return 0;
}</pre><p align="JUSTIFY">Identifikacijski broj dretve moguæe je dobiti pozivom funkcije <font face="Courier New" size="2">
pthread_self</font>: </p>
<p align="JUSTIFY">
<font face="Courier New" size="2">pthread_t pthread_self(void);</font></p>
</div>
<i><p align="JUSTIFY">Napomene</p>
</i></font><p align="JUSTIFY">
<span lang="EN-GB" style="font-family: Times New Roman; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: red">
<ins datetime="2015-10-27T09:05"><font size="3">Prilikom prevoðenja potrebno je 
postaviti zastavicu</font><span class="Apple-converted-space"><font size="3">&nbsp;</font></span></ins></span><span style="color: rgb(0, 0, 0); font-family: Times New Roman; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px"><i><span lang="EN-GB" style="font-family: Courier New; color: red"><ins datetime="2015-10-27T09:05"><font size="2">-pthread</font></ins></span></i></span><span lang="EN-GB" style="font-family: Times New Roman; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: red"><ins datetime="2015-10-27T09:05"><span class="Apple-converted-space"><font size="3">&nbsp;</font></span><font size="3">koja 
ukazuje<span class="Apple-converted-space">&nbsp;</span>na<span class="Apple-converted-space">&nbsp;</span>to 
da se korist</font></ins><font size="3"><ins datetime="2015-10-27T09:06">i</ins><ins datetime="2015-10-27T09:05"><span class="Apple-converted-space">&nbsp;</span>vi¹edretven</ins><ins datetime="2015-10-27T09:06">i 
program</ins></font><ins datetime="2015-10-27T09:05"><font size="3"><span class="Apple-converted-space">&nbsp;</span>(npr.</font><span class="Apple-converted-space"><font size="3">&nbsp;</font></span></ins></span><span lang="EN-GB" style="font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: Courier New; color: red"><ins datetime="2015-10-27T09:05"><font size="2">gcc</font><font size="2"> 
-</font></ins><font size="2"><ins datetime="2015-10-27T09:06">p</ins></font><ins datetime="2015-10-27T09:05"><font size="2">thread</font><font size="2"> 
prvi.c -o prvi</font></ins></span><span lang="EN-GB" style="font-family: Times New Roman; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: red"><ins datetime="2015-10-27T09:05"><font size="3">)</font></ins></span><font color="#FF0000">.</font></p>
<p align="JUSTIFY">(U inaèici UNIX operacijskog sustava <i>Solaris</i> prilikom prevoðenja potrebno je postaviti zastavicu <font face="Courier New" size="2">-D_REENTRANT</font> koja ukazuje na to da se koriste vi¹edretvene inaèice upotrijebljenih funkcija, ako takve postoje, te zastavicu -<i>lpthread </i>
, npr. <font face="Courier New" size="2">
gcc -D_REENTRANT -lpthread prvi.c -o prvi</font>.)</p>
<p align="JUSTIFY">Stranice (manual) POSIX dretvi u kojima su detaljno opisane 
funkcije za rad s dretvama <font face="Courier New" size="2"> <i>pthread</i>: 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread.htm">pthread</a>,
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_create.htm">pthread_create</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_exit.htm">pthread_exit</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_detach.htm">pthread_detach</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_join.htm">pthread_join</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_mutex_init.htm">pthread_mutex_init</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_mutex_lock.htm">pthread_mutex_lock</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_mutex_unlock.htm">pthread_mutex_unlock</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_mutex_destroy.htm">pthread_mutex_destroy</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_cond_init.htm">pthread_cond_init</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_cond_wait.htm">pthread_cond_wait</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/pthread_cond_signal.htm">pthread_cond_signal</a>, 
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/sem_init.htm">sem_init</a>, <a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/sem_wait.htm">sem_wait</a>,
<a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/sem_post.htm">sem_post</a>, <a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/pthread/sem_destroy.htm">sem_destroy</a>...</font></p>

<hr>
<p style="tab-stops:36.0pt"><u><b>Win32</b></u></p>
<p style="tab-stops:36.0pt">Stvaranje procesa pod Win32 obavlja se funkcijom
<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/createprocess.asp">
CreateProcess</a>(). <a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/misc/winprocesi.c">Primjer.</a></p>
<p style="tab-stops:36.0pt">Zajednièka memorija ostvaruje se pomoæu funkcija
<a href="http://msdn2.microsoft.com/en-us/library/aa366537.aspx">CreateFileMapping</a> i
<a href="http://msdn2.microsoft.com/en-us/library/aa366761.aspx">MapViewOfFile</a>. <a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/misc/Unix2Win.htm#Windows_example:_shared_memory">
Primjer</a></p>
<p style="tab-stops:36.0pt">Stvaranje dretvi pod Win32 obavlja se funkcijom
<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dllproc/base/createthread.asp">
CreateThread</a>(). <a href="http://zemris.fer.hr/predmeti/os/pripreme/upute/misc/windretve.c">Primjer.</a></p>



</body></html>